---
title: "Project notebook"
output: html_notebook
---

```{r}

# load the relevant packages
library(here)
library(ggplot2)
library(dplyr)

# load the functions
source(here("mcomsimr_simulate_MC2_function.R"))

# set a seed
set.seed(54258748)

# set-up model inputs
species <- 3
patches <- 3
timesteps <- 500
temp_fluc = 0.025
dispersal = 0.05
start_abun = 60
extirp_prob = 0.000001

optima = seq(0.3, 0.6, length.out = species)
env_niche_breadth = c(0.2, 0.2, 0.2)
max_r = 0.5
K_max = 150

int_min = 0.3
int_max = 0.8
intra = 1

# landscape parameters
# generate a random landscape
l.1 <- 
  data.frame(x = c(25, 50, 75),
             y = c(50, 50, 50))

# generate a random dispersal matrix
d.1 <- mcomsimr::dispersal_matrix(landscape = l.1, torus = TRUE, kernel_exp = 0.1, plot = FALSE)

# generate species environmental optima
t.1 <- 
  data.frame(species = 1:species,
             optima = optima,
             env_niche_breadth = env_niche_breadth,
             max_r = max_r,
             K_max = K_max)

# competition matrices
si.1 <- matrix(runif(n = species*species, min = int_min, max = int_max), 
               nrow = species, ncol = species)
si.1[lower.tri(si.1)] = t(si.1)[lower.tri(si.1)]
diag(si.1) <- intra
head(si.1)

# environmental heterogeneity
e.1 <- Simulate_env(patches = patches, timesteps = timesteps,
                    start_env = c(0.35, 0.5, 0.65), temp_fluc = 0.01)

ggplot(data = e.1,
       mapping = aes(x = time, y = env1)) +
  geom_line() +
  facet_wrap(~patch) +
  theme_classic()


```

# Scale and the BEF-slope

What is the relevant comparison when trying to determine the effect of scale on the BEF-slope? There are several analyses that simply use different grain sizes and correlate biodiversity and ecosystem functioning (e.g. Craven et al. 2020, GEB). However, there is no clear theoretical expectation for this (barring Thompson et al. 2018). If I simulate this situation using a simple metacommunity model, then there is no scale dependence on the raw slope. 

However, there is some scale-dependence on the proportional change in biomass for a given change in richness (i.e. Thompson et al. 2018), then there is a slight scale-dependence but one which is very minor.

```{r}

# experiment with different levels of dispersal and see how this changes

# simulate monocultures and mixtures in identical environmental conditions
MC_disp <- sim_metacomm_BEF(species = species, patches = patches,
                            dispersal = 0,
                            timesteps = 100, 
                            start_abun = start_abun,
                            extirp_prob = extirp_prob,
                            landscape = l.1, 
                            disp_mat = d.1, 
                            env.df = e.1, 
                            env_traits.df = t.1, 
                            int_mat = si.1,
                            meas_error = 5
                            )

# extract the correctly processed data
MC_disp <- 
  MC_disp$BEF_slope %>%
  filter(time == max(time))

# raw slope
split(MC_disp, MC_disp$patch) %>%
  sapply(., function(x) {
    lm.x <- lm(biomass ~ SR, data = x)
    coef(lm.x)[2]
  }) %>%
  mean(.)

lm.x <- lm(biomass ~ SR, data = MC_disp %>% group_by(mono_mix, SR) %>% summarise(biomass = mean(biomass)))
coef(lm.x)[2]

# proportion change (Thompson et al. 2018)
split(MC_disp, MC_disp$patch) %>%
  sapply(., function(x) {
    lm.x <- lm(log(biomass) ~ log(SR), data = x)
    exp(coef(lm.x)[2])
  }) %>%
  mean(.)

lm.x <- lm(log(biomass) ~ log(SR), data = MC_disp %>% group_by(mono_mix, SR) %>% summarise(biomass = mean(biomass)))
exp(coef(lm.x)[2])




```

But, what these models show is that simply considering different spatial grains and looking at the BEF relationship is not any different from taking the average of all individual spatial grains when the species richness gradient is implemented properly (i.e. varying initial species pool with all monocultures).

Why then have so many studies found this strong scale-dependence when using different grains (e.g. Chisholm et al. 2013; Craven et al. 2020). The reason is compositional turnover. Basically, the difference in species richness between the lowest diversity plot and the highest diversity plot at a large scale is usually grater than the difference in diversity within smaller plots. Thus, when we find this scale-dependence in the BEF-slope, all we are seeing is that the richness gradient is changing. As far as I can tell, this doesn't give us any particularly interesting insight.

# What is the right question then?

I think the right question is to compare a set of interacting patches (i.e. a metacommunity) to a set of patches equivalent patches that are not interacting. Therefore, for the metacommunity with species, I seed each species in monoculture into the whole metacommunity (i.e. metacommunity number = species number) and I seed a metacommunity with all species. I then calculate the slope.

Then, as a comparison, I recreate the same metacommunity design but not the patches are completely non-interactive. I then calculate the BEF slope for each patch-type individually (i.e. three separate BEF slopes). I then compare that mean BEF slope to the BEF slope of the interacting community.











