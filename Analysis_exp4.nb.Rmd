---
title: "Analysis_exp4"
output: html_notebook
---

This script should be the final analysis. It takes data from experiment 3 + the Kan treatment which has been re-run. 

Lars' mail: 

The to-do list includes:
Replace the present Kan data with data on Kan6 from the last experiment.

Fig 2. A and B: Power function production-richness with #environments and scale/heterogeneity per se as fill. For both simulations and experiment. 
       C and D: Overyielding. 
       E and F: transgressive overyielding. With function in mixtures = average of monocultures.

Fig. 4. Heatmap (triangle): e.g. scale on x-axis, heterogeneity on y-axis, fill with transgressive overyielding. 

Fig. S1. How linear slope changes with scale and heterogeneity for both simulation and experiment. 
         As Fig. 1 a and b (for the power function).

Fig. S2. Alternative choices of trait distributions and approaches to define yields in mixtures (dominance and weighted dominance).
         If we go for the average in the main text.

Fig. S3. Production of each strain in each environment.

Fig. S4. Production-richness relationships.

Fig. S5. Highlighting (in green) which strain is included in which combination in each environment.


ALSO: push data on Figshare and load from there

```{r, message=FALSE}
library(here)
library(dplyr)
library(tidyr)
library(broom)
library(forcats)
library(readr)
library(ggplot2)
library(RColorBrewer)
library(purrr)
library(gridExtra)
```

## read data

We have data from 11 plates, 4 different antibiotics in duplicates and three control plates. 

We have the following antibiotics:

+ Chloramphenicol (Cam)
+ Kanamycin A (Kan)
+ Tetracycline (Tet)
+ Trimethoprim (Trim)

```{r, message=FALSE, warning=FALSE}

path <- here("Data", 
             "Results_Exp3",
             "190904_mix5_QC_normalised_absolute_batch")

Files <- list.files(path, pattern = ".csv")

#exclude Kan from experiment 3
Files <- Files[!grepl("kan8", Files)]

File_list <- 
lapply(Files, function(x) {
  temp <- read_csv(paste(path, x, sep = "/"))
  name <- sub("^.+_(\\w+\\d)_.+","\\1", x)
  Name <- paste(toupper(substr(name,1,1)), substr(name,2,nchar(name)), sep ="")
  tempm <- mutate(temp,
                  Plate = Name,
                  Antibiotic = gsub("([a-zA-Z]+).+", "\\1", Name),
                  Replicate = substr(Name, nchar(Name), nchar(Name)))
  })

# load Kan from experiment 4

path2 <- here("Data", 
             "Results_Exp4_Kan",
             "Kan6",
             "191108_Lars_Kan6_Kan6_Kan6_M9_Jaime.phenotypes.NormalizedAbsoluteBatched")

Files2 <- list.files(path2, pattern = ".csv")

#exclude additional controle (Plate 4)
Files2 <- Files2[!grepl("plate_4", Files2)]

File_list2 <- 
lapply(Files2, function(x) {
  temp <- read_csv(paste(path2, x, sep = "/"))
  Name <- paste("Kan6", gsub(".+(\\d).csv", "\\1", x), sep = "_")
  tempm <- mutate(temp,
                  Plate = Name,
                  Antibiotic = gsub("([a-zA-Z]+).+", "\\1", Name),
                  Replicate = substr(Name, nchar(Name), nchar(Name)))
  })

```

example of aggar plate with bacterial colonies - each dot represents a unique species combination

![example Plate](Plate_example.jpg)

Each large plate has 1536 spots, corresponding to 12 replicated 96-Well plates with a control plate on every 4th position. 

The position of the strain combinations on each 96-well plate is identical and as follows:

![Strain positions](positions_96_plate.jpg)

We are interested in one response variables from the raw data:

+ growth yield (mainly)

## clean data

+ bind all dataframes together to one long dataframe
+ exclude unecessary varibales
+ rename variables
+ change type to numeric
+ backtransform Growth Yield from log2 to linear scale            !!!!!!!!!! <- check! Do we need to do that?
+ filter spots with control strain ("ATCC") as data are allready normalized
+ add column with richness of species combination

```{r}

Data <-  do.call("rbind", c(File_list, File_list2))

Data <- 
Data %>% 
  select(Plate, Antibiotic, Replicate,
         Row, Column, gene, 
         Phenotypes.ExperimentGrowthYield,
         Phenotypes.GenerationTime) %>% 
  rename(GrowthYield = Phenotypes.ExperimentGrowthYield) %>% 
  mutate(GrowthYield = as.numeric(GrowthYield)) %>% 
  rename(GenTime = Phenotypes.GenerationTime) %>% 
  mutate(GenTime = as.numeric(GenTime)) %>% 
  mutate(Replicate = as.character(Replicate)) %>% 
  mutate(withinPlateRep = gsub("\\w+\\.(\\d)", "\\1", gene)) %>% 
  mutate(gene = gsub("(\\w+)\\.\\d", "\\1", gene)) %>% 
  mutate(Antibiotic) %>% 
  mutate(Antibiotic = fct_relevel(Antibiotic, "Con", after = Inf)) %>% 
  filter(!grepl("ATCC", gene)) %>%
  filter(!grepl("control", gene)) %>% 
  mutate(Richness = nchar(gene)) 

summary(Data)
```

## check for block effects

!!! haven't looked at this yet might need to take this into account !!!
!!! model probably wrong too, this was only a very quick attempt !!!

```{r}

lm(GrowthYield ~ gene*Antibiotic + withinPlateRep, data = Data) %>% 
  tidy()

```



## exploratory graphs

### Fig. S3. 
Production of each strain in each environment.

```{r}
#decide on colour scheme
# Blues <- RColorBrewer::brewer.pal(9, "Blues")
# Blues <- Blues[c(2,4,6,8,9)]

Data %>% 
  filter(Richness ==1) %>% 
  ggplot(aes(x = Antibiotic, y = GrowthYield, colour = gene))+
  geom_point(position = position_jitterdodge(dodge.width = 0.5, jitter.width = 0.05), size = 0.6, alpha = 0.5)+
  geom_hline(yintercept = mean(Data[Data$Antibiotic == "Con", ]$GrowthYield), 
             linetype = "dashed", colour = "darkgrey")+
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", 
               colour = "black", size = 0.4,fatten = 0.1,
               position = position_dodge(width = 0.5), 
               aes(group = paste(gene, Antibiotic)))+
  scale_y_log10()+
  theme_bw()+
  #scale_color_viridis_d()
  scale_color_brewer(palette = "Set1")
  #scale_color_manual(values = Blues)

geom_pointrange()

ggsave(here("figures", "Fig_S3.pdf"), height = 4, width = 8)
```


### Fig. S4

Production-richness relationships.

```{r}

Data %>% 
  na.omit() %>% 
  group_by(Antibiotic) %>%
  nest() %>% 
  mutate(power_fit = map(data, ~lm(log(GrowthYield) ~ log(Richness), data = .))) %>% 
  mutate(power_fit = map(power_fit, augment)) %>% 
  unnest(cols = c(data, power_fit)) %>% 
  ggplot(aes(x = Richness, y = GrowthYield))+
  geom_point(position = position_jitter(width = 0.1, height = 0), 
             alpha = 0.2, size = 0.2, colour = "#377EB8")+
  geom_line(aes(x = Richness, y = exp(.fitted)), 
            colour = "black", size = 0.5)+
  geom_ribbon(aes(x = Richness, 
                  ymin = exp(.fitted - 2*.se.fit), 
                  ymax = exp(.fitted + 2*.se.fit),
                  group = Antibiotic), fill = "grey", alpha = 0.2)+
  facet_wrap(~Antibiotic, scales = "free_y")+
  theme_bw()


ggsave(here("figures", "Fig_S4.pdf"), height = 4, width = 8)

```

### Fig. S5. 

Highlighting (in green) which strain is included in which combination in each environment.

```{r, warning=FALSE}

strain <- filter(Data, Richness == 1) %>% pull(gene) %>% unique %>% sort

plots <- as.list(rep(NA, length(strain)))
names(plots) <- strain

for(i in seq_along(strain)){
  
plots[[i]] <-   
  Data %>% 
  na.omit() %>% 
  mutate(has_strain = grepl(strain[i], gene)) %>% 
  group_by(Antibiotic, has_strain) %>%
  nest() %>% 
  mutate(power_fit = map(data, ~lm(log(GrowthYield) ~ log(Richness), data = .))) %>% 
  mutate(power_fit = map(power_fit, augment)) %>% 
  unnest(cols = c(data, power_fit)) %>% 
  ggplot(aes(x = Richness, y = GrowthYield, colour = has_strain))+
  geom_point(position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0, dodge.width = 0.5), 
             alpha = 1, size = 0.4)+
  geom_line(aes(x = Richness, y = exp(.fitted), group = has_strain), 
            size = 0.5)+
  facet_wrap(~Antibiotic, scales = "free_y")+
  scale_color_manual(values = c("grey", "#4DAF4A"), name = "Strain in mixture")+
  theme_bw()+
  theme(legend.position = if(i == 1){c(0.9, 0.2)} else{"none"})+
  labs(title = paste("Strain", strain[i]))
  
}

ggsave(file = here("figures", "Fig_S5.pdf"), 
       arrangeGrob(grobs = plots, ncol = 2), 
       width = 16, height = 12 )  ## save plot

plots
```


# Analysis

## observed vs expected mixture preformance

here we calculate the expected mixture performance for each strain combination in each enviornment under three scenarios:

1) Mixture performance is average of monoculture performances (subsitution design)
2) Mixture performance is equal to highest monoculture performance (total dominance)
3) Mixture performance is equal to weighted average of monoculture performance where the strains are weighted by their monocultre performance

```{r}

# extract Data for monocultures and take mean over all replicates within and across plates 

Data_mono <- 
  Data %>%
  filter(Richness == 1) %>% 
  group_by(Antibiotic, gene) %>%
  summarize(mean_Yield = mean(GrowthYield, na.rm = T),
            median_Yield = median(GrowthYield, na.rm = T))

Data_poly <-
  Data %>% 
  filter(Richness > 1)

spec_comb <- sapply(2:5, function(x) combn(letters[1:6][-2], x))
env <- unique(as.character(Data$Antibiotic))

res <- lapply(spec_comb, function(x){ # for each richness level
  apply(x, 2, function(y){ # for each species combination
    lapply(as.list(env), function(z){ # for each environment
      
      # performance of strains in species combination (y) in
      # that environment (z) in monoculture
      
      expected <- Data_mono[Data_mono$Antibiotic == z & 
                         Data_mono$gene %in% y,]$mean_Yield
      
      # calculate expected mixture performance based on 
      # monoculture values and three different scenarios
      # mean : average performance; max : better strains dominates
      # wmean : weighted mean performance were the rel abundance of each strain
      # is proportional to it's monoculture performance
      
      tibble(Antibiotic = z,
             gene = paste0(y, collapse = ""),
             expected_mean = mean(expected),
             expected_max = max(expected),
             expected_wmean = mean(sum(expected^2)/abs(sum(expected))))
      
    })
  })
})

# unlist results to dataframe of expected values
Expected <- 
  unlist(res, recursive = F) %>%
  unlist(recursive = F) %>%
  bind_rows()

# calculate difference of observed and expected 
Data_poly <- 
Data_poly %>% 
  left_join(Expected) %>% 
  mutate(Average =  GrowthYield - expected_mean,
         Dominance = GrowthYield - expected_max,
         Weighted = GrowthYield - expected_wmean) %>% 
  mutate(Antibiotic = factor(Antibiotic)) %>% 
  mutate(Antibiotic = fct_relevel(Antibiotic, "Con", after = Inf)) 
```


```{r}

Data_poly %>% 
  select(Antibiotic, Richness, Average, Dominance, Weighted) %>% 
  gather(type, value, -Richness, -Antibiotic) %>%
  mutate(type = fct_relevel(type, "weighted", after = 1)) %>% 
  ggplot(aes(x = as.factor(Richness), y = value, colour = type))+
  geom_point(position = position_jitterdodge(jitter.height = 0, jitter.width = 0.2),
             size = 0.4, 
             alpha = 0.1)+
  geom_abline(slope = 0)+
  facet_grid(type~Antibiotic)+
  theme_bw()+
  scale_color_brewer(palette = "Set1")
  
```


## average performance for all environment combinations

Here we calculate the mean functioning for each strain and strain combinations for all possible combinations of environments. 

As there is no sensible way how the replicated measurements should be matched across environments, we first calculate the average for each strain combination in each environment. 

```{r, warning=FALSE}

Data_wide <- 
  Data %>% 
  select(Richness, gene, Antibiotic, GrowthYield) %>% 
  group_by(Richness, gene, Antibiotic) %>% 
  #mutate(rep = 1:n()) %>% 
  summarise(GrowthYield = mean(GrowthYield, na.rm = T)) %>% 
  spread(Antibiotic, GrowthYield)

# vector of environemnts
ab <- as.character(unique(Data$Antibiotic))

# list of all possible combinations of environments
ab_comb <- sapply(1:length(ab), function(x) combn(ab, x))

# number of species
specnum <- length(unique(Data_mono$gene))

env_values <- 
lapply(ab_comb, function(x) { #for all levels of environmental richness (1:5)
  apply(x, 2, function(y) { #for all combination of environments
   
     df <- data.frame(
       env_comb = paste0(y, collapse = " "), # which combination of environemnts
       envnum = length(y), # what environmental richness
       richness = Data_wide$Richness, 
       gene = Data_wide$gene,
       #replicate = Data_wide$rep,
       functioning = rowMeans(Data_wide[,y]) #mean of functioning across environments
                     )
  })
  })

# expand to dataframe with average function for each 
# species richness level, 
# each species combination,
# and each environmental combination


env_values <- bind_rows(unlist(env_values, recursive = FALSE))
```


plot 
```{r}

Col <- c(brewer.pal(9, "Greens")[c(5,7,9)], brewer.pal(9, "Blues")[c(5,7,9)])[c(1,4,2,5,3,6)]

LarsCol <- c(123,63,3,
             214,123,1,
             255,124,0,
             255,168,69,
             255,210,8) %>% 
  `/`(265) %>% 
  matrix(ncol = 3, byrow = TRUE) %>% 
  rgb()

Fig_2_b <- 
env_values %>%
  group_by(envnum) %>% 
  nest() %>% 
  mutate(log_fit = map(data, ~lm(log(functioning) ~ log(richness), data = .))) %>% 
  mutate(log_fit = map(log_fit, tidy)) %>% 
  unnest(log_fit) %>% 
  select(-std.error, -statistic, -p.value) %>% 
  spread(term, estimate) %>% 
  mutate(power_fit = map(data, ~nls(functioning ~ a*richness^b, data = ., 
                                    start = list(a = exp(`(Intercept)`) , b = `log(richness)`)))) %>%  
  mutate(power_fit = map(power_fit, augment)) %>% 
  unnest(cols = power_fit) %>% 
  ggplot(aes(x = richness, y = functioning, colour = as.factor(envnum)))+
  geom_point( size = 1, alpha = 1, position = position_dodge(width = 0.7))+
  geom_line(aes(y = .fitted, group = envnum), position = position_dodge(width = 0.7))+
  scale_color_manual(values = LarsCol, name = "spatial scale")+
  theme_classic()+
  labs(y = "average functioning", x = "species richness")+
  guides(colour = guide_legend(ncol = 3))+
  theme(legend.position = c(0.85,0.85), 
        legend.background = element_rect(fill = "transparent"),
        axis.ticks.length=unit(-0.25, "cm"),
        axis.text.x = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")),
        axis.text.y = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")))+
  #coord_fixed(ratio = 1/2e8)+
  NULL

save("Fig_2_b", file = here("figures", "Fig_2_b.RData"))

Fig_2_b

#slopes

env_values %>%
  group_by(envnum) %>% 
  nest() %>% 
  mutate(log_fit = map(data, ~lm(log(functioning) ~ log(richness), data = .))) %>% 
  mutate(log_fit = map(log_fit, tidy)) %>% 
  unnest(log_fit) %>% 
  select(-std.error, -statistic, -p.value) %>% 
  spread(term, estimate) %>% 
  mutate(power_fit = map(data, ~nls(functioning ~ a*richness^b, data = ., 
                                    start = list(a = exp(`(Intercept)`) , b = `log(richness)`)))) %>% 
  mutate(power_fit = map(power_fit, tidy)) %>% 
  unnest(cols = power_fit) %>% 
  filter(term == "b") %>% 
  select(envnum, estimate, p.value) %>% 
  mutate_if(is.numeric, round, digits = 3)
```

now we calculate 

```{r}

env_metrics <- 
  env_values %>% 
  group_by(env_comb, envnum) %>%
  nest() %>% 
  mutate(linear_fit = map(data, ~lm(functioning ~ richness, data = .))) %>%
  mutate(linear_fit = map_dbl(linear_fit, function(x) coef(x)[2])) %>% 
  mutate(log_fit = map(data, ~lm(log(functioning) ~ log(richness), data = .))) %>% 
  mutate(log_fit = map(log_fit, tidy)) %>% 
  unnest(log_fit) %>% 
  select(-std.error, -statistic, -p.value) %>% 
  spread(term, estimate) %>% 
  mutate(power_fit = map(data, ~nls(functioning ~ a*richness^b, data = ., 
                                    start = list(a = exp(`(Intercept)`) , b = `log(richness)`)))) %>%  
  mutate(power_fit = map_dbl(power_fit, function(x) coef(x)[2])) %>% 
   mutate(overyield = map_dbl(data, function(x) {
     mean(x[x$richness == specnum,]$functioning, na.rm = T) / 
       mean(x[x$richness == 1,]$functioning, na.rm = T)})) %>% 
  mutate(transgressive = map_dbl(data, function(x) {
    x %>% 
      group_by(gene) %>% 
      filter(richness %in% c(1, specnum)) %>% 
      summarise(functioning = mean(functioning, na.rm = T), richness = unique(richness)) %>% 
      group_by(richness) %>% 
      summarise(functioning = max(functioning, na.rm = T)) %>% 
      {.[.$richness == specnum,]$functioning /
          .[.$richness == 1,]$functioning}
    })) %>%
 # mutate(transgressive = (transgressive-1)*100) %>% 
  {.}

```



```{r}
d <- tibble(linear_fit = c(-0.2,0.2),
            overyield = c(-20, 20),
            power_fit = c(-0.2,0.2),
            transgressive = c(-50, 50)) %>% 
  gather(metric, value)

env_metrics %>% 
  select(-data, -`(Intercept)`, -`log(richness)`) %>% 
  gather(metric, value, -envnum, -env_comb) %>% 
  ggplot(aes(x = envnum, y = value))+
  geom_point(position = position_jitter(width = 0.1), fill = "dodgerblue3", size = 2, shape = 21, alpha = 0.7)+
  facet_wrap(~metric, scales = "free_y")+
  stat_smooth(method = "lm", se = F, size = 0.5, colour = "darkred")+
  theme_bw()+
  labs(x = "number of environments")

ggsave(here("figures", "slopes_by_N_Env_norm.pdf"), width = 6, height = 5)
  
```


```{r}
Fig_2_d <- 
env_metrics %>% 
  select(-data, -`(Intercept)`, -`log(richness)`) %>% 
  gather(metric, value, -envnum, -env_comb) %>%
  filter(metric == "overyield") %>% 
  ggplot(aes(x = envnum, y = value, colour = as.factor(envnum)))+
  geom_point( size = 4, alpha = 1, position = position_jitter(width = 0.1))+
  stat_smooth(method = "lm", se = F, size = 0.5, colour = "darkred")+
  scale_color_manual(values = LarsCol)+
  theme_classic()+
  labs(y = "overyielding", x = "spatial scale")+
  theme(legend.position = "none",
        axis.ticks.length=unit(-0.25, "cm"),
        axis.text.x = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")),
        axis.text.y = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")))+
  #coord_fixed(ratio = 2)+
  NULL


save("Fig_2_d", file = here("figures", "Fig_2_d.RData"))

Fig_2_d

env_metrics %>% 
  select(-data) %>% 
  gather(metric, value, -envnum, -env_comb) %>%
  filter(metric == "overyield") %>% 
  lm(value ~ envnum, data = .) %>% 
  tidy %>% 
  mutate_if(is.numeric, round, 3)

```

```{r}
Fig_2_f <- 
env_metrics %>% 
  select(-data, -`(Intercept)`, -`log(richness)`) %>% 
  gather(metric, value, -envnum, -env_comb) %>% 
  filter(metric == "transgressive") %>% 
  ggplot(aes(x = envnum, y = value, colour = as.factor(envnum)))+
  geom_point( size = 4, alpha = 1, position = position_jitter(width = 0.1))+
  stat_smooth(method = "lm", se = F, size = 0.5, colour = "darkred")+
  scale_color_manual(values = LarsCol)+
  theme_classic()+
  labs(y = "transgressive overyielding", x = "spatial scale")+
  theme(legend.position = "none",
        axis.ticks.length=unit(-0.25, "cm"),
        axis.text.x = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")),
        axis.text.y = element_text(margin=unit(c(0.5,0.5,0.5,0.5), "cm")))+
  #scale_y_continuous(limits = c(0,NA))+
  #coord_fixed(ratio = 2/0.4)+
  NULL

save("Fig_2_f", file = here("figures", "Fig_2_f.RData"))

Fig_2_f

env_metrics %>% 
  select(-data) %>% 
  gather(metric, value, -envnum, -env_comb) %>%
  filter(metric == "transgressive") %>% 
  lm(value ~ envnum, data = .) %>% 
  tidy %>% 
  mutate_if(is.numeric, round, 3)

```


######

```{r, eval = FALSE}

# vector of environemnts
ab <- as.character(unique(Data$Antibiotic))

#vector of all possible environment combinations *including with repeated environments*
ab_comb <- sapply(1:length(ab), function(x) gtools::combinations(length(ab), x, ab, repeats.allowed=TRUE))
  # apply(1, table) #%>% 
  # bind_rows() #%>% 
  # vegan::renyi(., scales = 1, hill = T)

# number of species
specnum <- length(unique(Data_mono$gene))

env_values <- 
lapply(ab_comb, function(x) { #for all levels of environmental richness (1:5)
  apply(x, 1, function(y) { #for all combination of environments
   
     df <- tibble(
       env_comb = paste0(y, collapse = " "), # which combination of environemnts
       envnum = length(y), # what environmental richness
       envdiv = as.numeric(vegan::renyi(table(y), scales = 1, hill = T)),
       richness = Data_wide$Richness, 
       gene = Data_wide$gene,
       #replicate = Data_wide$rep,
       functioning = rowMeans(Data_wide[,y]) #mean of functioning across environments
                     )
  })
  })

# expand to dataframe with average function for each 
# species richness level, 
# each species combination,
# and each environmental combination


env_values <- bind_rows(unlist(env_values, recursive = FALSE))
```


```{r, eval = FALSE}
env_metrics <- 
  env_values %>% 
  group_by(env_comb, envnum, envdiv) %>%
  nest() %>% 
  mutate(linear_fit = map(data, ~lm(functioning ~ richness, data = .))) %>%
  mutate(linear_fit = map_dbl(linear_fit, function(x) coef(x)[2])) %>% 
  mutate(log_fit = map(data, ~lm(log(functioning) ~ log(richness), data = .))) %>% 
  mutate(log_fit = map(log_fit, tidy)) %>% 
  unnest(log_fit) %>% 
  select(-std.error, -statistic, -p.value) %>% 
  spread(term, estimate) %>% 
  mutate(power_fit = map(data, ~nls(functioning ~ a*richness^b, data = ., 
                                    start = list(a = exp(`(Intercept)`) , b = `log(richness)`)))) %>%  
  mutate(power_fit = map_dbl(power_fit, function(x) coef(x)[2])) %>% 
   mutate(overyield = map_dbl(data, function(x) {
     mean(x[x$richness == specnum,]$functioning, na.rm = T) / 
       mean(x[x$richness == 1,]$functioning, na.rm = T)})) %>% 
  mutate(transgressive = map_dbl(data, function(x) {
    x %>% 
      group_by(gene) %>% 
      filter(richness %in% c(1, specnum)) %>% 
      summarise(functioning = mean(functioning, na.rm = T), richness = unique(richness)) %>% 
      group_by(richness) %>% 
      summarise(functioning = max(functioning, na.rm = T)) %>% 
      {.[.$richness == specnum,]$functioning /
          .[.$richness == 1,]$functioning}
    })) %>%
  mutate(transgressive = (transgressive-1)*100) %>% 
  {.}

res <- 
env_metrics %>% 
  group_by(envnum, envdiv) %>%
  summarise(transgressive = mean(transgressive)) 

res_int <- akima::interp(res$envnum, res$envdiv, res$transgressive)
 
df <- 
expand_grid(envnum = res_int$x, envdiv = res_int$y) %>% 
  as_tibble() %>% 
  mutate(transgressive = c(t(res_int$z))) %>% 
  na.omit()

ggplot(df, aes(x = envdiv ,y = envnum , fill = transgressive))+
  geom_raster()+
  geom_point(data = res, shape = 22, colour = "red", size = 4)+
  scale_fill_viridis_c()+
  theme_bw()


# install.packages("akima")
# library(akima)


```

